<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gemini CLI Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .chat-container {
      max-height: 70vh;
      overflow-y: auto;
      scroll-behavior: smooth;
    }
    .chat-message {
      max-width: 80%;
      margin: 8px 16px;
      padding: 12px 16px;
      border-radius: 12px;
      word-wrap: break-word;
    }
    .user-message {
      background-color: #3b82f6;
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    .gemini-message {
      background-color: #e5e7eb;
      color: #1f2937;
      border-bottom-left-radius: 4px;
    }
    .error-message {
      background-color: #fee2e2;
      color: #dc2626;
      margin-left: auto;
      margin-right: auto;
      text-align: center;
    }
    .loading::after {
      content: '';
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #1f2937;
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 1s linear infinite;
      margin-left: 8px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen">
  <div class="w-full max-w-2xl p-4">
    <h1 class="text-3xl font-bold text-center text-blue-400 mb-4">Gemini CLI Chat</h1>
    <div class="chat-container bg-gray-800 rounded-lg shadow-lg p-4 mb-4" id="chat-container">
      <div id="chat-messages"></div>
    </div>
    <div class="flex space-x-2">
      <input
        type="text"
        id="input"
        placeholder="输入你的问题..."
        class="flex-1 px-4 py-2 bg-gray-700 text-gray-100 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
        onkeypress="if(event.key === 'Enter') sendRequest()"
      >
      <button
        onclick="sendRequest()"
        id="submit-btn"
        class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition disabled:bg-blue-300"
      >
        发送
      </button>
      <button
        onclick="clearChat()"
        class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition"
      >
        清空
      </button>
    </div>
  </div>

  <script>
    const chatMessages = document.getElementById('chat-messages');
    const chatContainer = document.getElementById('chat-container');
    const conversations = []; // 存储对话历史

    function addMessage(content, isUser = false, isError = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${isUser ? 'user-message' : isError ? 'error-message' : 'gemini-message'}`;
      messageDiv.textContent = content;
      chatMessages.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight; // 滚动到底部
    }

    async function sendRequest() {
      const input = document.getElementById('input');
      const submitBtn = document.getElementById('submit-btn');
      const userInput = input.value.trim();

      if (!userInput) {
        addMessage('请输入问题！', false, true);
        return;
      }

      // 添加用户消息
      addMessage(userInput, true);
      conversations.push({ role: 'user', content: userInput });
      input.value = '';
      submitBtn.disabled = true;
      addMessage('加载中...', false, false);

      try {
        console.log('Sending request with input:', userInput);
        const response = await fetch('/api/gemini', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ input: userInput })
        });
        const data = await response.json();
        console.log('Received response:', data);

        // 移除加载消息
        chatMessages.lastChild.remove();

        if (data.response) {
          addMessage(data.response, false);
          conversations.push({ role: 'gemini', content: data.response });
        } else {
          addMessage(data.error || '无响应', false, true);
        }
      } catch (error) {
        console.error('Request failed:', error);
        chatMessages.lastChild.remove();
        addMessage('请求失败: ' + error.message, false, true);
      } finally {
        submitBtn.disabled = false;
        input.focus();
      }
    }

    function clearChat() {
      conversations.length = 0;
      chatMessages.innerHTML = '';
    }
  </script>
</body>
</html>
